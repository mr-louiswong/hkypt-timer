<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HKYPT Physics Fight Timer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes flash {
            0%, 100% { background-color: rgb(254 226 226); }
            50% { background-color: rgb(254 202 202); }
        }
        .flash-red {
            animation: flash 1s infinite;
        }
        .timer-row {
            transition: background-color 0.3s ease;
        }
        .progress-bar {
            transition: width 1s linear;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="max-w-6xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-4">Hong Kong Young Physicists' Tournament</h1>
            <h2 class="text-3xl font-semibold text-gray-700">Physics Fight Timer</h2>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="grid gap-4">
                <!-- Timer Row 1: Presentation of the report -->
                <div class="timer-row p-4 rounded-lg bg-gray-50">
                    <div class="grid grid-cols-[2fr,1fr,1fr,auto,auto] gap-4 items-center mb-2">
                        <div class="font-semibold">Presentation of the report</div>
                        <div class="text-center">12:00</div>
                        <div class="remaining text-center font-mono text-xl">12:00</div>
                        <button class="start-pause px-4 py-2 rounded bg-blue-500 text-white hover:bg-blue-600">Start</button>
                        <button class="reset px-4 py-2 rounded bg-gray-500 text-white hover:bg-gray-600">Reset</button>
                    </div>
                    <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div class="progress-bar h-full bg-blue-500 w-full"></div>
                    </div>
                </div>

                <!-- Timer Row 2: Questions of the Opponent to the Reporter and answers of the Reporter -->
                <div class="timer-row p-4 rounded-lg bg-gray-50">
                    <div class="grid grid-cols-[2fr,1fr,1fr,auto,auto] gap-4 items-center mb-2">
                        <div class="font-semibold">Questions of the Opponent to the Reporter and answers of the Reporter</div>
                        <div class="text-center">2:00</div>
                        <div class="remaining text-center font-mono text-xl">2:00</div>
                        <button class="start-pause px-4 py-2 rounded bg-blue-500 text-white hover:bg-blue-600">Start</button>
                        <button class="reset px-4 py-2 rounded bg-gray-500 text-white hover:bg-gray-600">Reset</button>
                    </div>
                    <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div class="progress-bar h-full bg-blue-500 w-full"></div>
                    </div>
                </div>

                <!-- Timer Row 3: Preparation of the Opponent -->
                <div class="timer-row p-4 rounded-lg bg-gray-50">
                    <div class="grid grid-cols-[2fr,1fr,1fr,auto,auto] gap-4 items-center mb-2">
                        <div class="font-semibold">Preparation of the Opponent</div>
                        <div class="text-center">3:00</div>
                        <div class="remaining text-center font-mono text-xl">3:00</div>
                        <button class="start-pause px-4 py-2 rounded bg-blue-500 text-white hover:bg-blue-600">Start</button>
                        <button class="reset px-4 py-2 rounded bg-gray-500 text-white hover:bg-gray-600">Reset</button>
                    </div>
                    <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div class="progress-bar h-full bg-blue-500 w-full"></div>
                    </div>
                </div>

                <!-- Timer Row 4: The Opponent takes the floor and discussion between the Reporter and the Opponent -->
                <div class="timer-row p-4 rounded-lg bg-gray-50">
                    <div class="grid grid-cols-[2fr,1fr,1fr,auto,auto] gap-4 items-center mb-2">
                        <div class="font-semibold">The Opponent takes the floor (MAX 4 mins) and discussion between the Reporter and the Opponent</div>
                        <div class="text-center">14:00</div>
                        <div class="remaining text-center font-mono text-xl">14:00</div>
                        <button class="start-pause px-4 py-2 rounded bg-blue-500 text-white hover:bg-blue-600">Start</button>
                        <button class="reset px-4 py-2 rounded bg-gray-500 text-white hover:bg-gray-600">Reset</button>
                    </div>
                    <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div class="progress-bar h-full bg-blue-500 w-full"></div>
                    </div>
                </div>

                <!-- Timer Row 5: The Opponent summarizes the discussion -->
                <div class="timer-row p-4 rounded-lg bg-gray-50">
                    <div class="grid grid-cols-[2fr,1fr,1fr,auto,auto] gap-4 items-center mb-2">
                        <div class="font-semibold">The Opponent summarizes the discussion</div>
                        <div class="text-center">1:00</div>
                        <div class="remaining text-center font-mono text-xl">1:00</div>
                        <button class="start-pause px-4 py-2 rounded bg-blue-500 text-white hover:bg-blue-600">Start</button>
                        <button class="reset px-4 py-2 rounded bg-gray-500 text-white hover:bg-gray-600">Reset</button>
                    </div>
                    <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div class="progress-bar h-full bg-blue-500 w-full"></div>
                    </div>
                </div>

                <!-- Timer Row 6: Questions of the Jury -->
                <div class="timer-row p-4 rounded-lg bg-gray-50">
                    <div class="grid grid-cols-[2fr,1fr,1fr,auto,auto] gap-4 items-center mb-2">
                        <div class="font-semibold">Questions of the Jury</div>
                        <div class="text-center">5:00</div>
                        <div class="remaining text-center font-mono text-xl">5:00</div>
                        <button class="start-pause px-4 py-2 rounded bg-blue-500 text-white hover:bg-blue-600">Start</button>
                        <button class="reset px-4 py-2 rounded bg-gray-500 text-white hover:bg-gray-600">Reset</button>
                    </div>
                    <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div class="progress-bar h-full bg-blue-500 w-full"></div>
                    </div>
                </div>

                <!-- Timer Row 7: All jurors writing comments -->
                <div class="timer-row p-4 rounded-lg bg-gray-50">
                    <div class="grid grid-cols-[2fr,1fr,1fr,auto,auto] gap-4 items-center mb-2">
                        <div class="font-semibold">All jurors writing comments</div>
                        <div class="text-center">5:00</div>
                        <div class="remaining text-center font-mono text-xl">5:00</div>
                        <button class="start-pause px-4 py-2 rounded bg-blue-500 text-white hover:bg-blue-600">Start</button>
                        <button class="reset px-4 py-2 rounded bg-gray-500 text-white hover:bg-gray-600">Reset</button>
                    </div>
                    <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div class="progress-bar h-full bg-blue-500 w-full"></div>
                    </div>
                </div>

                <!-- Timer Row 8: Open scoring -->
                <div class="timer-row p-4 rounded-lg bg-gray-50">
                    <div class="grid grid-cols-[2fr,1fr,1fr,auto,auto] gap-4 items-center mb-2">
                        <div class="font-semibold">Open scoring</div>
                        <div class="text-center">5:00</div>
                        <div class="remaining text-center font-mono text-xl">5:00</div>
                        <button class="start-pause px-4 py-2 rounded bg-blue-500 text-white hover:bg-blue-600">Start</button>
                        <button class="reset px-4 py-2 rounded bg-gray-500 text-white hover:bg-gray-600">Reset</button>
                    </div>
                    <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div class="progress-bar h-full bg-blue-500 w-full"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const beepSound = new Audio("data:audio/wav;base64,..."); // Your beep sound

        document.querySelectorAll('.timer-row').forEach(timerRow => {
            let timeRemainingEl = timerRow.querySelector('.remaining');
            let startPauseBtn = timerRow.querySelector('.start-pause');
            let resetBtn = timerRow.querySelector('.reset');
            let progressBar = timerRow.querySelector('.progress-bar');
            let initialTime = timeRemainingEl.textContent;
            let [minutes, seconds] = initialTime.split(':').map(Number);
            let totalSeconds = minutes * 60 + seconds;
            let remainingSeconds = totalSeconds;
            let interval;
            let isRunning = false;
            let startTime;
            let drift = 0;

            function updateDisplay() {
                const mins = Math.floor(remainingSeconds / 60);
                const secs = remainingSeconds % 60;
                timeRemainingEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                
                const progressPercentage = (remainingSeconds / totalSeconds) * 100;
                progressBar.style.width = `${progressPercentage}%`;
                
                if (progressPercentage <= 25) {
                    progressBar.classList.remove('bg-blue-500', 'bg-yellow-500');
                    progressBar.classList.add('bg-red-500');
                } else if (progressPercentage <= 50) {
                    progressBar.classList.remove('bg-blue-500', 'bg-red-500');
                    progressBar.classList.add('bg-yellow-500');
                } else {
                    progressBar.classList.remove('bg-yellow-500', 'bg-red-500');
                    progressBar.classList.add('bg-blue-500');
                }
            }

            function syncWithExternalTime() {
                fetch('https://worldtimeapi.org/api/ip')
                    .then(response => response.json())
                    .then(data => {
                        const serverTime = new Date(data.utc_datetime).getTime();
                        const localTime = Date.now();
                        const timeDifference = serverTime - localTime;
                        drift = timeDifference / 1000; // Convert to seconds
                    })
                    .catch(error => {
                        console.error('Error fetching time:', error);
                    });
            }

            startPauseBtn.addEventListener('click', () => {
                if (isRunning) {
                    clearInterval(interval);
                    startPauseBtn.textContent = 'Start';
                    timerRow.classList.remove('bg-green-100');
                    timerRow.classList.add('bg-gray-50');
                    timerRow.classList.remove('flash-red');
                    isRunning = false;
                } else {
                    startTime = performance.now();
                    timerRow.classList.remove('bg-gray-50');
                    timerRow.classList.add('bg-green-100');
                    timerRow.classList.remove('flash-red');
                    startPauseBtn.textContent = 'Pause';
                    isRunning = true;
                    interval = setInterval(() => {
                        const elapsed = (performance.now() - startTime) / 1000;
                        remainingSeconds = totalSeconds - Math.floor(elapsed) + drift;
                        if (remainingSeconds > 0) {
                            updateDisplay();
                        } else {
                            clearInterval(interval);
                            beepSound.play();
                            timerRow.classList.remove('bg-green-100');
                            timerRow.classList.add('flash-red');
                            startPauseBtn.textContent = 'Start';
                            isRunning = false;
                        }
                    }, 100);
                }
            });

            resetBtn.addEventListener('click', () => {
                clearInterval(interval);
                remainingSeconds = totalSeconds;
                updateDisplay();
                startPauseBtn.textContent = 'Start';
                timerRow.classList.remove('bg-green-100');
                timerRow.classList.remove('flash-red');
                timerRow.classList.add('bg-gray-50');
                isRunning = false;
            });

            // Sync with external time source every 5 minutes
            setInterval(syncWithExternalTime, 5 * 60 * 1000);
            syncWithExternalTime(); // Initial sync
        });
    </script>
</body>
</html>